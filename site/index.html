<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>WeRelate SlickGrid Example</title>
		<link rel="stylesheet" href="../slick.grid.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="examples.css" type="text/css" media="screen" charset="utf-8" />
		<script src="../lib/firebugx.js"></script>

		<script src="../lib/jquery-1.7.min.js"></script>
		<script src="../lib/jquery-ui-1.8.16.custom.min.js"></script>
		<script src="../lib/jquery.event.drag-2.0.min.js"></script>

		<script src="../slick.core.js"></script>
		<script src="../slick.editors.js"></script>
		<script src="../slick.grid.js"></script>
		<script src="../slick.dataview.js"></script>
		<style>
		.cell-title {
			font-weight: bold;
		}

		.cell-effort-driven {
			text-align: center;
		}

		.toggle {
			height: 9px;
			width: 9px;
			display: inline-block;
		}


	</style>
	</head>
	<body>
		<table width="100%">
		<tr>
			<td valign="top" width="900px">
				<div style="border:1px solid gray;background:wheat;padding:6px; width: 850px;">
					<br/>
					<div id = "treeFilter"></div>
					<label>Search Filter:</label>
					<input type=text id="txtSearch">
				</div>
				<br/>
				<div id="myGrid" style="width:850px;height:500px;"></div>
			</td>
		</tr>
		</table>

		<script type="text/javascript">

// Hardcoded my user for testing. This will obviously need to be updated to grab the current user ID.
var user = "Jdfoote1";

// Set global variables
		var dataView;
		var grid;

		var data = [];

// Set up SlickGrid display columns
		var columns = [
			{id:"linkedName", name:"Name", field:"linkedName", cssClass:"cell-title", width:150, sortable: true},
			{id:"gender", name:"Gender", field:"gender", width:45},
			{id:"birthDate", name:"Birth Date", field:"birthDate"},
			{id:"birthPlace", name:"Birth Place", field:"birthPlace", width:150, sortable: false},
			{id:"deathDate", name:"Death Date", field:"deathDate"},
			{id:"deathPlace", name:"Death Place", field:"deathPlace", width: 150, sortable: false}
		];

// Set SlickGrid options
		var options = {
			editable: false,
			enableAddRow: false,
			enableCellNavigation: true,
			asyncEditorLoading: false,
			forceFitColumns: true
		};


		var searchString = "";

// Define search filter (currently searches name, birth place, and death place)
		function myFilter(item) {

			var searchFields = ["name","birthPlace","deathPlace"];
			if (searchString !== ""){
				searchString = searchString.toUpperCase();
				var itemFound = false;
				for (i in searchFields){
					if (item[searchFields[i]].toUpperCase().indexOf(searchString) != -1){
						itemFound = true;
					}
				}
				if (itemFound === false){
					return false;
				}
			}

// This is from the original example, and I'm not sure that I understand what it's doing. I think we will need code like this to filter lists that have parents.
			var idx = dataView.getIdxById(item.id);

			if (item.parent != null) {
				var parent = data[item.parent];

				while (parent) {
					if (parent._collapsed || (searchString != "" && parent["title"].indexOf(searchString) == -1) )	
						return false;

					parent = data[parent.parent];
				}
			}

			return true;
		}

// This is my function to do a sort by name any time we change the data.

function initialSort(){
	sortcol = "linkedName";
	dataView.sort(comparer, 1);
}

// This is the comparer. Right now, it just sorts based on the name.
	function comparer(a,b) {
		if (sortcol === "linkedName"){
		var x = a["name"], y = b["name"];
		return (x == y ? 0 : (x > y ? 1 : -1));
	}
} 

		
	// This function takes a user, and returns a list of their active trees.
	function getTreeList(user){
		var jsonURL = 'http://werelate.org/w/index.php?action=ajax&rs=wfGetTrees&user=' + user + '&callback=?';
		$.getJSON(jsonURL,function(json){
		// Set up the select menu
		$('#treeFilter').append('<label>Select Tree: </label><select id="treeSelect" onchange="loadNewTree(user,this.value)"><option value="wfWatchlist" selected="selected">All Trees</option></select>')
		$.each(json, function(key,text){
			// Create an option in the select menu for each tree
			$('#treeSelect').append('<option value="' + text + '">' + text + '</option>')
		});
	});
}

// This function loads a new tree from the dropdown list.
function loadNewTree(user, treeName){
	var newData = [];
	// Check if it's asking for a tree, or for the full watchlist
	if (treeName != "wfWatchlist"){
		var jsonURL = 'http://werelate.org/w/index.php?action=ajax&rs=wfGetTree&user=' + user + '&tree=' + treeName + '&callback=?';
		$.getJSON(jsonURL,function(json){
		var treePeople = [];
		// Go through each item and put it into the treePeople array
	  $.each(json, function(key,val) {
		  treePeople.push(val);
		 });
		// Compare the treePeople array with the current data. Add the people who are in the tree to newData
		for(var i=0; i<data.length; i++){
			if ($.inArray(data[i].title,treePeople) != -1){
				newData.push(data[i]);
			}
		}
		// Update the data in the grid, and then update the grid
		dataView.setItems(newData);
		grid.updateRowCount();
		grid.render();
		initialSort();
});
}
else { // If they want the whole watchlist, then reset to the original data.
	dataView.setItems(data);
	grid.updateRowCount();
	grid.render();
	initialSort();
}
}

	// This function takes a user name and tree name, loads the data, and initializes the grid. This has to be called before the grid shows up.
	function loadTree(user){
		var jsonURL = 'http://werelate.org/w/index.php?action=ajax&rs=wfGetWatchlist&user=' + user + '&callback=?';
		$.getJSON(jsonURL,function(json){
	var items = [];
	// Go through each item and put it into the data object
  $.each(json, function(key, val) {
	  var d = (data[key] = {});
	  var parent = null;
	  var indent = 0;
				d["id"] = "id_" + key;
				d["indent"] = indent;
				// This refers to whether a node has a parent in the grid
				d["parent"] = parent;
				d["title"] = val.title;
				// This is used for searching, not display
				d["name"] = val.surname + ", " + val.given||"";
				d["linkedName"] = '<a href="http://www.werelate.org/wiki/Person:' + val.title + '">' + val.surname + ', ' + val.given + '</a>'||"";
				d["gender"] = val.gender||"";
				d["birthDate"] = val.birthDate||"";
				d["birthPlace"] = val.birthPlace||"";
				d["deathDate"] = val.deathDate||"";
				d["deathPlace"] = val.deathPlace||"";
			});



// Everything below here is copied directly from the SlickGrid example

			// initialize the model
			dataView = new Slick.Data.DataView();
			dataView.beginUpdate();
			dataView.setItems(data);
			dataView.setFilter(myFilter);
			dataView.endUpdate();


			// initialize the grid
			grid = new Slick.Grid("#myGrid", dataView, columns, options);

            grid.onCellChange.subscribe(function(e,args) {
                dataView.updateItem(args.item.id,args.item);
            });
            

			grid.onClick.subscribe(function(e,args) {
                if ($(e.target).hasClass("toggle")) {
                    var item = dataView.getItem(args.row);
                    if (item) {
                        if (!item._collapsed)
                            item._collapsed = true;
                        else
                            item._collapsed = false;

                        dataView.updateItem(item.id, item);
                    }
                    e.stopImmediatePropagation();
                }
            });
            

         grid.onSort.subscribe(function(e, args) {
			sortdir = args.sortAsc ? 1 : -1;
			sortcol = args.sortCol.field; 
			dataView.sort(comparer, args.sortAsc);
		});


			// wire up model events to drive the grid
			dataView.onRowCountChanged.subscribe(function(e,args) {
				grid.updateRowCount();
                grid.render();
			});

			dataView.onRowsChanged.subscribe(function(e,args) {
				grid.invalidateRows(args.rows);
				grid.render();
			});


			var h_runfilters = null;


			// wire up the search textbox to apply the filter to the model
			$("#txtSearch").keyup(function(e) {
                Slick.GlobalEditorLock.cancelCurrentEdit();

				// clear on Esc
				if (e.which == 27)
					this.value = "";

				searchString = this.value;
				dataView.refresh();
			})
		initialSort(); // Ok - this is mine, not from SlickGrid.
		})
		};

// Ready, set, go.
$(function()
		{
			loadTree(user);
			getTreeList(user);
		}
		);

		</script>
	</body>
</html>
